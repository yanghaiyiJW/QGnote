
#### 1.学习定时器前需要明白的几点
①51 单片机有两组定时器/计数器，因为既可以定时，又可以计数，故称之
为定时器/计数器。
②定时器/计数器和单片机的 CPU 是相互独立的。定时器/计数器工作的过程是自动完成的，不需要 CPU 的参与。
③51 单片机中的定时器/计数器是根据机器内部的时钟或者是外部的脉冲信
号对寄存器中的数据加 1。
有了定时器/计数器之后，可以增加单片机的效率，一些简单的重复加 1 的工作可以交给定时器/计数器处理。CPU 转而处理一些复杂的事情。同时可以实现精确定时作用。

#### 4.定时器



#### 3.定时器配置
①对 TMOD 赋值，以确定 T0 和 T1 的工作方式，如果使用定时器 0 即对 T0 配置，如果使用定时器 1 即对 T1 配置。
②根据所要定时的时间计算初值,并将其写入 TH0、TL0 或 TH1、TL1。
③如果使用中断，则对 EA 赋值，开放定时器中断。
④使 TR0 或 TR1 置位，启动定时/计数器定时或计数。
- 这里以定时器 0 为例介绍配置定时器工作方式 1、设定 1ms 初值，开启定时
器计数功能以及总中断，如下：
```c
void time0_init(void)
{
TMOD|=0X01;//选择为定时器 0 模式，工作方式 1
TH0=0XFC; //给定时器赋初值，定时 1ms
TL0=0X18;
ET0=1;//打开定时器 0 中断允许
EA=1;//打开总中断
TR0=1;//打开定时器
}
```

#### 4.代码块
案例：LED闪烁
```c
#include <REGX52.H>

void Timer0Init(void)		
{
		
	TMOD &= 0xF0;		//设置定时器模式
	TMOD |= 0x01;		//设置定时器模式
	TL0 = 0x18;		//设置定时初始值
	TH0 = 0xFC;		//设置定时初始值
	TF0 = 0;		//清除TF0标志
	TR0 = 1;		//定时器0开始计时
}
 void main ()
 {
	 Timer0Init();
	 while(1)
	 {
		 
	 }
 }
 unsigned int T0Count;
 void Timer0_Routine() interrupt 1
 {
	 TL0 = 0x18;		
	 TH0 = 0xFC;		
	 T0Count++;
	 if(T0Count>1000)
	 {
		 T0Count=0;
		 P2_0=~P2_0;
	 }
 }
 
```
#### 4.代码解析
```c
    TMOD &= 0xF0;		
    TMOD |= 0x01;		
```
- 为了在配置低位时不影响高位
- ---
```c
    TL0 = 0x18;		
    TH0 = 0xFC;		
```
- 前面介绍过机器周期的概念，它是 CPU 完成一个基本操作所需要的时间。其计算公式是：机器周期=1/单片机的时钟频率。51 单片机内部时钟频率是外部时钟的 12 分频，也就是说当外部晶振的频率输入到单片机里面的时候要进行 12分频。比如说用的是 12MHZ 晶振，那么单片机内部的时钟频率就是 12/12MHZ，当使用 12MHZ 的外部晶振的时候，机器周期=1/1M=1us。如果想定时 1ms的初值是多少呢？1ms/1us=1000。也就是要计数 1000 个，初值=65535-1000+1（因为实际上计数器计数到 65536（2 的 16 次方）才溢出，所以后面要加 1）=64536=FC18H，所以初值即为 THx=0XFC，TLx=0X18。
- 知道了如何计算定时/计数器初值，那么想定时多长时间都可以计算出，当然由于定时计数器位数有限，我们不可能直接通过初值定时很长时间，如果要实现很长时间的定时，比如定时 1 秒钟。可以通过初值设置定时 1ms，每当定时 1ms结束后又重新赋初值，并且设定一个全局变量累计定时 1ms 的次数，当累计到1000 次，表示已经定时 1 秒了。需要其他定时时间类似操作，这样我们就可以使用定时器来实现精确延时来替代之前的 delay 函数。
-----
```c
void Timer0Init(void)		
{
		
	TMOD &= 0xF0;		//设置定时器模式
	TMOD |= 0x01;		//设置定时器模式
	TL0 = 0x18;		//设置定时初始值
	TH0 = 0xFC;		//设置定时初始值
	TF0 = 0;		//清除TF0标志
	TR0 = 1;		//定时器0开始计时
}
```
- 这是直接通过配置软件stc-isp参数得到的函数，以后可以这样获取想要的函数，比较方便。